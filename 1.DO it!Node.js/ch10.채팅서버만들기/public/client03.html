<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>채팅 클라이언트 01</title>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.11.2/css/all.css"
    />
    <script src="jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <link href="./client03.css" rel="stylesheet" />
    <script>
      let host;
      let port;
      let socket;

      // 문서 로딩 후 실행됨
      $(function () {
        // 연결하기 버튼 클릭 처리
        $("#connectButton").bind("click", function (event) {
          println("connectButton이 클릭되었습니다.");

          host = $("#hostInput").val();
          port = $("#portInput").val();

          connectToServer();
        });

        //로그인 버튼을 클릭하면 처리
        $("#loginButton").bind("click", function (event) {
          let id = $("#idInput").val();
          let password = $("#passwordInput").val();
          let alias = $("#aliasInput").val();
          let today = $("#todayInput").val();

          let output = {
            id: id,
            password: password,
            alias: alias,
            today: today,
          };
          console.log("서버로 보낼 데이터 : " + JSON.stringify(output));

          if (socket == undefined) {
            alert("서버에 연결되어 있지 않습니다. 먼저 서버에 연결하세요.");
            return;
          }

          socket.emit("login", output);
        });

        //방 만들기 버튼을 클릭하면 처리
        $("#createRoomButton").bind("click", function (event) {
          let roomId = $("#roomIdInput").val();
          let roomName = $("#roomNameInput").val();
          let id = $("#idInput").val();

          let output = {
            command: "create",
            roomId: roomId,
            roomName: roomName,
            roomOwner: id,
          };
          console.log("서버로 보낼 데이터 : " + JSON.stringify(output));

          if (socket == undefined) {
            alert("서버에 연결되어 있지 않습니다. 먼저 서버에 연결하세요.");
            return;
          }

          socket.emit("room", output);
        });

        //방 이름 바꾸기 버튼을 클릭하면 처리
        $("#updateRoomButton").bind("click", function (event) {
          let roomId = $("#roomIdInput").val();
          let roomName = $("#roomNameInput").val();
          let id = $("#idInput").val();

          let output = {
            command: "update",
            roomId: roomId,
            roomName: roomName,
            roomOwner: id,
          };
          console.log("서버로 보낼 데이터 : " + JSON.stringify(output));

          if (socket == undefined) {
            alert("서버에 연결되어 있지 않습니다. 먼저 서버에 연결하세요.");
            return;
          }

          socket.emit("room", output);
        });

        //방 없애기 버튼을 클릭하면 처리
        $("#deleteRoomButton").bind("click", function (event) {
          let roomId = $("#roomIdInput").val();

          let output = { command: "delete", roomId: roomId };
          console.log("서버로 보낼 데이터 : " + JSON.stringify(output));

          if (socket == undefined) {
            alert("서버에 연결되어 있지 않습니다. 먼저 서버에 연결하세요.");
          }

          socket.emit("room", output);
        });

        // 전송 버튼 클릭 시 처리
        $("#sendButton").bind("click", function (event) {
          //chattype 구별
          let chattype = $("#chattype option:selected").val();

          let sender = $("#senderInput").val();
          let recepient = $("#recepientInput").val();
          let data = $("#dataInput").val();

          let output = {
            sender: sender,
            recepient: recepient,
            command: chattype,
            type: "text",
            data: data,
          };
          console.log("서버로 보낼 데이터 : " + JSON.stringify(output));

          if (socket == undefined) {
            alert("서버에 연결되어 있지 않습니다. 먼저 서버에 연결하세요.");
            return;
          }

          socket.emit("message", output);
        });

        //방 입장하기 버튼을 클릭하면 처리
        $("#joinRoomButton").bind("click", function (event) {
          let roomId = $("#roomIdInput").val();

          let output = { command: "join", roomId: roomId };
          console.log("서버로 보낼 데이터 : " + JSON.stringify(output));

          if (socket === undefined) {
            alert("서버에 연결되어 있지 않습니다. 먼저 서버에 연결하세요.");
            return;
          }
          socket.emit("room", output);
        });

        //방 나가기 버튼을 클릭하면 처리
        $("#leaveRoomButton").bind("click", function (event) {
          let roomId = $("#roomIdInput").val();

          let output = { command: "leave", roomId: roomId };
          console.log("서버로 보낼 데이터 : " + JSON.stringify(output));

          if (socket === undefined) {
            alert("서버에 연결되어 있지 않습니다. 먼저 서버에 연결하세요.");
            return;
          }
          socket.emit("room", output);
        });
      });

      // 서버에 연결하는 함수 정의
      function connectToServer() {
        const options = { forceNew: true };
        let url = "http://" + host + ":" + port;
        socket = io.connect(url, options);

        socket.on("connect", function () {
          println("웹소켓 서버에 연결되었습니다. : " + url);

          socket.on("message", function (message) {
            console.log(JSON.stringify(message));

            println(
              "<p>수신 메시지 : " +
                message.sender +
                ", " +
                message.recepient +
                ", " +
                message.command +
                ", " +
                message.data +
                "</p>"
            );
          });

          socket.on("response", function (response) {
            console.log("응답 : " + JSON.stringify(response));
            println(
              "응답 메시지를 받았습니다. : " +
                response.command +
                ", " +
                response.code +
                ", " +
                response.message
            );
          });
        });

        //그룹 채팅에서 방과 관련된 이벤트 처리
        socket.on("room", function (data) {
          console.log(JSON.stringify(data));

          println("<p>방 이벤트: " + data.command + "</p>");
          println("<p>방 리스트를 받았습니다.</p>");
          if (data.command == "list") {
            //방 리스트
            let roomCount = data.rooms.length;
            $("#roomList").html("<p>방 리스트" + roomCount + "개</p>");
            for (var i = 0; i < roomCount; i++) {
              $("#roomList").append(
                "<p>방 #" +
                  i +
                  " : " +
                  data.rooms[i].id +
                  ", " +
                  data.rooms[i].name +
                  ", " +
                  data.rooms[i].owner +
                  "</p>"
              );
            }
          }
        });

        socket.on("disconnect", function () {
          println("웹소켓 연결이 종료되었습니다.");
        });
      }

      function println(data) {
        console.log(data);
        $("#result").append("<p>" + data + "</p>");
      }
    </script>
  </head>
  <body>
    <div class="chat">
      <div class="title">
        <h1><i class="far fa-comments"></i>그룹&일대일 채팅</h1>
        <div class="smalltitle">연결 및 로그인 후 메세지를 보내세요.</div>
      </div>
      <br />
      <div>
        <div class="connect">
          <input type="text" id="hostInput" value="localhost" />
          <input type="text" id="portInput" value="3000" />
        </div>
        <div>
          <input
            type="button"
            id="connectButton"
            value="연결하기"
            class="connectButton"
          />
        </div>
      </div>

      <div>
        <div class="id">
          <input type="text" id="idInput" value="test01" />
          <input type="password" id="passwordInput" value="123456" />
        </div>
        <div class="name">
          <input type="text" id="aliasInput" value="소녀시대" />
          <input type="text" id="todayInput" value="좋은 날!" />
        </div>
        <div>
          <input
            type="button"
            id="loginButton"
            value="로그인"
            class="loginButton"
          />
          <input
            type="button"
            id="logoutButton"
            value="로그아웃"
            class="logoutButton"
          />
        </div>
      </div>

      <div>
        <div class="room">
          <input type="text" id="roomIdInput" value="meeting01" />
          <input type="text" id="roomNameInput" value="talking room" />
        </div>
        <div>
          <input
            type="button"
            id="createRoomButton"
            value="방 만들기"
            class="roomButton"
          />
          <input
            type="button"
            id="updateRoomButton"
            value="방 이름 바꾸기"
            class="roomButton"
          />
          <input
            type="button"
            id="deleteRoomButton"
            value="방 없애기"
            class="roomButton"
          />
        </div>
      </div>
      <br />
      <div id="roomList"></div>

      <div>
        <input
          type="button"
          id="joinRoomButton"
          value="방 입장하기"
          class="roomButton"
        />
        <input
          type="button"
          id="leaveRoomButton"
          value="방 나가기"
          class="roomButton"
        />
      </div>
      <div>
        <div>
          <div class="sendid">
            <span>보내는 사람 아이디 : </span>
            <input type="text" id="senderInput" value="test01" />
          </div>
          <div class="recepientid">
            <span>받는 사람 아이디 : </span>
            <input type="text" id="recepientInput" value="ALL" />
          </div>
        </div>

        <!-- command 선택 <select> 채팅, 그룹 채팅 -->
        <select name="chattype" id="chattype" class="chattype">
          <option value="chat">채팅</option>
          <option value="groupchat" selected>그룹 채팅</option>
        </select>

        <div class="messagedata">
          <span>메시지 데이터 : </span>
          <input type="text" id="dataInput" value="안녕!" />
        </div>
        <input type="button" id="sendButton" value="전송" class="sendButton" />
      </div>
      <div class="line">메시지</div>
      <div id="result" class="result"></div>
    </div>
  </body>
</html>
